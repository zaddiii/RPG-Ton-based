




<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RPG TON Battle Arena — Claim Reward</title>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <style>
    body{ font-family: system-ui, sans-serif; background: #f6ecd7; color:#111; display:flex; flex-direction:column; align-items:center; padding:36px; }
    #connectRoot{ margin-bottom:10px; }
    button{ padding:10px 16px; border-radius:10px; border:none; background:#0b67ff; color:#fff; cursor:pointer; margin:8px;}
    #messages{ margin-top:12px; min-height:20px; font-weight:600; color:#333;}
    #wallet{ word-break:break-all; color:#0b67ff; }
  </style>
</head>
<body>
  <h1>RPG TON Battle Arena</h1>

  <div id="connectRoot"></div>
  <div>Connected wallet: <span id="wallet">not connected</span></div>
  <div id="messages"></div>

  <div style="margin-top:18px;">
    <button id="claimBtn" disabled>Claim 50 RPG (DevNet)</button>
  </div>

<script type="module">
(async ()=>{

  // ---- CONFIG: update these if you host server at a different URL ----
  const BACKEND_REWARD_URL = "https://YOUR_SERVER_DOMAIN_OR_IP/api/reward"; // <- replace with your server
  const REWARD_AMOUNT = 50; // tokens to send

  // init TonConnect UI
  if(!window.TON_CONNECT_UI){
    document.getElementById('messages').innerText = "TonConnect UI library failed to load — check network.";
    return;
  }
  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    // optional manifest if you host one:
    manifestUrl: window.location.origin + "/tonconnect-manifest.json",
    buttonRootId: "connectRoot"
  });

  // ensure the UI mounts button
  try { tonConnectUI.render?.(); } catch(e){ /* ignore */ }

  const walletSpan = document.getElementById("wallet");
  const messages = document.getElementById("messages");
  const claimBtn = document.getElementById("claimBtn");

  // helper: get connected address from TonConnectUI (supports multiple shapes)
  function getConnectedAddress(){
    try{
      if(tonConnectUI.account && tonConnectUI.account.address) return tonConnectUI.account.address;
      if(tonConnectUI.connector && tonConnectUI.connector.account && tonConnectUI.connector.account.address) return tonConnectUI.connector.account.address;
      if(tonConnectUI.connectedWallet && tonConnectUI.connectedWallet.account && tonConnectUI.connectedWallet.account.address) return tonConnectUI.connectedWallet.account.address;
    }catch(e){}
    return null;
  }

  // Poll connection and update UI
  setInterval(()=>{
    const a = getConnectedAddress();
    walletSpan.innerText = a || "not connected";
    claimBtn.disabled = !a;
  }, 800);

  // When user clicks claim: do two things:
  // 1) show confirmation alert to user
  // 2) call backend POST /api/reward { to: address, amount: 50 }
  claimBtn.onclick = async ()=>{
    const address = getConnectedAddress();
    if(!address){ alert("Connect your wallet first"); return; }

    // user confirmation
    if(!confirm(`You will receive ${REWARD_AMOUNT} RPG tokens to ${address} (DevNet). Proceed?`)) return;

    messages.innerText = "Requesting reward from server...";
    try {
      const res = await fetch(BACKEND_REWARD_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ to: address, amount: REWARD_AMOUNT })
      });
      if(!res.ok){
        const txt = await res.text();
        messages.innerText = `Server failed: ${res.status} ${txt}`;
        alert("Reward failed — check console and server logs.");
        return;
      }
      const json = await res.json();
      // the server should return { ok:true, tx: <txid/descr> } on success
      if(json.ok){
        messages.innerText = `Server claim accepted — tx: ${json.tx || "unknown"}`;
        alert(`Success — reward request accepted. Server tx: ${json.tx || "unknown"}`);
      } else {
        messages.innerText = `Server returned error: ${JSON.stringify(json)}`;
        alert("Reward failed — server returned error.");
      }
    } catch(err){
      console.error(err);
      messages.innerText = "Network error when calling server.";
      alert("Network error when calling server. Check server URL & CORS.");
    }
  };

})();
</script>
</body>
</html>