



<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>RPG TON Battle Arena</title>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 36px;
    background: #0d1117;
    font-family: system-ui, sans-serif;
    color: #fff;
  }
  h2 { margin-bottom: 16px; }
  button {
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    color: #fff;
    background: #007bff;
    transition: background 0.2s;
  }
  button:disabled { background: #555; cursor: not-allowed; }
  #walletInfo, #message {
    margin: 12px 0;
    text-align: center;
    word-break: break-all;
  }
  #gameArea, #claimArea {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    margin-top: 20px;
  }
</style>
</head>
<body>
<h2>üéÆ RPG TON Battle Arena</h2>
<div id="connect"></div>
<div id="walletInfo">üî¥ Wallet not connected</div>

<!-- GAME AREA -->
<div id="gameArea">
  <p>üî• Game in progress... Fight bravely!</p>
  <button id="finishGame">Finish Game</button>
</div>

<!-- CLAIM AREA -->
<div id="claimArea">
  <button id="claimBtn" disabled>Claim 50 RPG (DevNet)</button>
</div>

<div id="message"></div>

<script type="module">
const BACKEND_REWARD_URL = "https://ton-reward-server.vercel.app/api/reward-api";
const REWARD_AMOUNT = 50;

const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: "https://zaddiii.github.io/RPG-Ton-based/tonconnect-manifest.json",
  uiOptions: { buttonRootId: "connect" }
});
tonConnectUI.render?.();

const walletInfo = document.getElementById("walletInfo");
const gameArea = document.getElementById("gameArea");
const claimArea = document.getElementById("claimArea");
const finishGameBtn = document.getElementById("finishGame");
const claimBtn = document.getElementById("claimBtn");
const message = document.getElementById("message");

let gameFinished = false;

function getWalletAddress() {
  try {
    return tonConnectUI.account?.address ||
           tonConnectUI.connector?.account?.address ||
           tonConnectUI.connectedWallet?.account?.address || null;
  } catch { return null; }
}

function updateUI() {
  const addr = getWalletAddress();
  if (addr) {
    walletInfo.innerHTML = `‚úÖ Connected Wallet:<br>${addr}`;
    gameArea.style.display = gameFinished ? "none" : "flex";
    claimArea.style.display = gameFinished ? "flex" : "none";
  } else {
    walletInfo.innerHTML = "üî¥ Wallet not connected";
    gameArea.style.display = "none";
    claimArea.style.display = "none";
  }
  claimBtn.disabled = !addr || !gameFinished;
}

// Poll wallet connection every 700ms
setInterval(updateUI, 700);

tonConnectUI.onStatusChange(() => updateUI());

finishGameBtn.addEventListener("click", () => {
  gameFinished = true;
  message.textContent = "üéØ Game completed! You can now claim your reward.";
  updateUI();
});

claimBtn.addEventListener("click", async () => {
  const address = getWalletAddress();
  if (!address) { alert("Please connect your wallet first."); return; }

  if (!confirm(`You will receive ${REWARD_AMOUNT} RPG tokens to ${address}. Proceed?`)) return;

  claimBtn.disabled = true;
  message.textContent = "‚è≥ Processing claim...";

  try {
    const res = await fetch(BACKEND_REWARD_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ to: address, amount: REWARD_AMOUNT })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      message.textContent = `Server error: ${res.status}`;
      alert("Reward failed ‚Äî check server logs.");
      claimBtn.disabled = false;
      return;
    }

    if (data.ok) {
      message.textContent = `‚úÖ Reward sent! Tx: ${data.tx}`;
      alert(`Success! Transaction: ${data.tx}`);
    } else {
      message.textContent = `‚ùå Server error: ${data.error || "unknown"}`;
      alert(`Server error: ${data.error || "unknown"}`);
    }
  } catch (err) {
    console.error(err);
    message.textContent = "‚ö†Ô∏è Network error while claiming reward.";
    alert("Network error ‚Äî check your connection.");
  } finally {
    claimBtn.disabled = false;
  }
});
</script>
</body>
</html>