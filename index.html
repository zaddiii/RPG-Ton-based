




<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPG TON Battle Arena v2</title>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: sans-serif;
    background: burlywood;
    color: black;
    text-align: center;
    padding: 20px;
  }
  #connect { margin-bottom: 20px; }
  #walletInfo { margin-bottom: 20px; word-break: break-all; }
  #gameArea button,
  .startbutton {
    border: none;
    border-radius: 15px;
    padding: 8px 15px;
    margin: 5px;
    background-color: white;
    color: black;
    font-weight: bold;
    cursor: pointer;
  }
  #gameArea { margin-top: 20px; display: none; }
</style>
</head>
<body>

<h1>🎮 RPG TON Battle Arena</h1>
<div id="connect"></div>
<div id="walletInfo">🔴 Wallet not connected</div>

<div id="gameArea">
  <p>Player Health: <span id="playerHealth">100</span></p>
  <p>Player Mana: <span id="playerMana">30</span></p>
  <p>Enemy Health: <span id="enemyHealth">100</span></p>
  <p>Enemy Mana: <span id="enemyMana">30</span></p>

  <button onclick="playerAction('Attack')">Attack</button>
  <button onclick="playerAction('Defend')">Defend</button>
  <button onclick="playerAction('Special')">Special (-20 MP)</button>
  <button onclick="playerAction('Heal')">Heal (+30 HP, -10 MP)</button>
  <button onclick="resetGame(true)">Reset Game</button>
</div>

<h2>Scoreboard</h2>
<p>Player Wins: <span id="playerWins">0</span></p>
<p>Enemy Wins: <span id="enemyWins">0</span></p>

<button class="startbutton" onclick="startGame()" style="display:none;">Start Game</button>

<script type="module">
document.addEventListener("DOMContentLoaded", () => {
  const walletInfo = document.getElementById("walletInfo");
  const gameArea = document.getElementById("gameArea");
  const startButton = document.querySelector(".startbutton");

  // --- TON CONNECT ---
  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: "https://zaddiii.github.io/RPG-Ton-based/tonconnect-manifest.json",
    uiOptions: { buttonRootId: "connect" }
  });
  tonConnectUI.render?.();

  function getWalletAddress() {
    try {
      return tonConnectUI.account?.address ||
             tonConnectUI.connector?.account?.address ||
             tonConnectUI.connectedWallet?.account?.address || null;
    } catch { return null; }
  }

  function updateUI() {
    const addr = getWalletAddress();
    if (addr) {
      walletInfo.innerHTML = `✅ Connected Wallet:<br>${addr}`;
      startButton.style.display = "inline-block"; // show start button after connect
    } else {
      walletInfo.innerHTML = "🔴 Wallet not connected";
      startButton.style.display = "none";
      gameArea.style.display = "none";
    }
  }

  setInterval(updateUI, 700);
  tonConnectUI.onStatusChange(updateUI);

  // --- RPG GAME LOGIC ---
  let playerHealth, enemyHealth, playerMana, enemyMana;
  let scores = { player: 0, enemy: 0 };
  let playerDefending = false;
  let enemyDefending = false;
  let manaRegenInterval;
  let gameLog = [];

  function startGame() {
    resetGame(false);
    gameArea.style.display = "block";
    startButton.style.display = "none";
    alert("Welcome to the Arena ⚔️!");
  }

  function resetGame(fullReset = false) {
    playerHealth = 100; enemyHealth = 100; playerMana = 30; enemyMana = 30;
    playerDefending = false; enemyDefending = false;
    gameLog = [];

    if (fullReset) { scores = { player: 0, enemy: 0 }; updateScoreboard(); }

    updateStats();

    if (manaRegenInterval) clearInterval(manaRegenInterval);
    manaRegenInterval = setInterval(() => {
      if (playerMana < 30) playerMana++;
      if (enemyMana < 30) enemyMana++;
      updateStats();
    }, 2000);
  }

  function updateStats() {
    document.getElementById("playerHealth").innerText = playerHealth;
    document.getElementById("enemyHealth").innerText = enemyHealth;
    document.getElementById("playerMana").innerText = playerMana;
    document.getElementById("enemyMana").innerText = enemyMana;
  }

  function updateScoreboard() {
    document.getElementById("playerWins").innerText = scores.player;
    document.getElementById("enemyWins").innerText = scores.enemy;
  }

  function logAction(text) { gameLog.push(text); console.log(text); }
  function recapLog(winner) { console.log("=== MATCH ENDED ==="); console.log("Winner: " + winner); gameLog.forEach((e,i)=>console.log((i+1)+". "+e)); }

  function playerAction(action) {
    playerDefending = false;
    if (action === "Attack") {
      let dmg = Math.floor(Math.random() * 10) + 10;
      if (enemyDefending) dmg = Math.floor(dmg/2);
      enemyHealth -= dmg;
      alert(`You attacked for ${dmg}!`);
      logAction(`Player attacks for ${dmg}.`);
    } else if (action === "Defend") {
      playerDefending = true;
      alert("You defend this turn.");
      logAction("Player defends.");
    } else if (action === "Special" && playerMana >= 20) {
      let dmg = Math.floor(Math.random() * 15) + 25;
      if (enemyDefending) dmg = Math.floor(dmg/2);
      enemyHealth -= dmg; playerMana -= 20;
      alert(`You used a Special Attack! Enemy takes ${dmg} damage!`);
      logAction(`Player uses Special → ${dmg} dmg, -20 MP.`);
    } else if (action === "Heal" && playerMana >= 10) {
      playerHealth = Math.min(playerHealth+30,100); playerMana -= 10;
      alert("You healed for 30 HP!");
      logAction("Player heals +30 HP, -10 MP.");
    } else {
      alert("Not enough mana!");
      logAction("Failed action: Not enough mana.");
    }
    updateStats(); checkGameOver();
    if (enemyHealth > 0) setTimeout(enemyTurn, 800);
  }

  function enemyTurn() {
    enemyDefending = false;
    let choice;
    if (enemyHealth <= 50 && enemyMana >= 10) choice = Math.random()<0.6?"Heal":"Defend";
    else if (enemyMana >= 20 && Math.random()<0.5) choice="Special";
    else if (Math.random()<0.2) choice="Defend";
    else choice="Attack";

    if(choice==="Attack"){let dmg=Math.floor(Math.random()*10)+10;if(playerDefending)dmg=Math.floor(dmg/2);playerHealth-=dmg;alert(`Enemy attacks you for ${dmg}!`);logAction(`Enemy attacks for ${dmg}.`);}
    else if(choice==="Defend"){enemyDefending=true;alert("Enemy defends this turn.");logAction("Enemy defends.");}
    else if(choice==="Special"&&enemyMana>=20){let dmg=Math.floor(Math.random()*15)+25;if(playerDefending)dmg=Math.floor(dmg/2);playerHealth-=dmg;enemyMana-=20;alert(`Enemy uses Special Attack! You take ${dmg} damage!`);logAction(`Enemy Special → ${dmg} dmg, -20 MP.`);}
    else if(choice==="Heal"&&enemyMana>=10){enemyHealth=Math.min(enemyHealth+30,100);enemyMana-=10;alert("Enemy heals for 30 HP!");logAction("Enemy heals +30 HP, -10 MP.");}
    updateStats(); checkGameOver();
  }

  function checkGameOver() {
    if(playerHealth<=0){alert("You Lose!");logAction("Game Over → Player loses.");recapLog("Enemy");scores.enemy++;updateScoreboard();resetGame();}
    else if(enemyHealth<=0){alert("You Win!");logAction("Game Over → Player wins.");recapLog("Player");scores.player++;updateScoreboard();resetGame();}
  }

});
</script>
</body>
</html>