




<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RPG Game ‚Äî God AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #001f3f; font-family: "Times New Roman", serif; }
    .bar { transition: width 0.25s ease; }
    .bar-text { position: absolute; top: 50%; transform: translateY(-50%); right: 6px; }
    .toast {
      position: fixed; top: 20px; right: 20px;
      background: #1a1c28; color: #fff; padding: 15px 20px;
      border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      opacity: 0; transform: translateY(-20px);
      transition: opacity 0.4s ease, transform 0.4s ease; z-index: 9999;
      font-weight: 500;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .meta { font-size:13px; color:#cbd5e1; margin-bottom:8px; text-align:center; }
    .addr { word-break: break-all; color:#8be9fd; font-weight:600; }
    /* Hide connected wallet address from UI */
    #connectedAddr { display: none; }
  </style>
</head>

<body class="text-white flex flex-col items-center min-h-screen p-2 sm:p-4 md:p-6 overflow-x-hidden">
  <h1 class="text-xl sm:text-2xl md:text-3xl font-bold mt-4 mb-2 text-center">RPG Battle Arena</h1>

  <div id="scoreboard" class="fixed top-3 left-3 bg-blue-950/80 p-3 rounded-xl shadow-lg text-xs w-[130px] sm:w-[150px]">
    <p><strong>Player Wins:</strong> <span id="playerWins">0</span></p>
    <p><strong>Enemy Wins:</strong> <span id="enemyWins">0</span></p>
    <p><strong>Score:</strong> <span id="score">0</span></p>
    <p><strong>AI IQ:</strong> <span id="aiIQ">0</span></p>
  </div>

  <div class="meta">
    Connected address: <span id="connectedAddr" class="addr">‚Äî waiting from parent ‚Äî</span><br/>
  </div>

  <div id="gameArea" class="hidden flex justify-center w-full mt-4">
    <div class="bg-blue-950/30 rounded-2xl shadow-xl p-4 sm:p-5 w-full max-w-3xl flex flex-col gap-4">
      <div>
        <p class="text-lg sm:text-xl font-semibold text-center">üßë‚ÄçüéÆ Player</p>
        <div class="relative bg-gray-800 rounded-lg h-4 w-full overflow-hidden my-2">
          <div id="playerHealthBar" class="bar bg-red-600 h-full w-full"></div>
          <span id="playerHealthText" class="absolute bar-text text-[11px] sm:text-xs">200 / 200</span>
        </div>
        <div class="relative bg-gray-800 rounded-lg h-4 w-full overflow-hidden">
          <div id="playerManaBar" class="bar bg-blue-500 h-full w-full"></div>
          <span id="playerManaText" class="absolute bar-text text-[11px] sm:text-xs">50 / 50</span>
        </div>
      </div>

      <div>
        <p class="text-lg sm:text-xl font-semibold text-center">üëæ Enemy</p>
        <div class="relative bg-gray-800 rounded-lg h-4 w-full overflow-hidden my-2">
          <div id="enemyHealthBar" class="bar bg-red-600 h-full w-full"></div>
          <span id="enemyHealthText" class="absolute bar-text text-[11px] sm:text-xs">200 / 200</span>
        </div>
        <div class="relative bg-gray-800 rounded-lg h-4 w-full overflow-hidden">
          <div id="enemyManaBar" class="bar bg-blue-500 h-full w-full"></div>
          <span id="enemyManaText" class="absolute bar-text text-[11px] sm:text-xs">50 / 50</span>
        </div>
        <div class="relative bg-gray-800 rounded-lg h-4 w-full overflow-hidden mt-2">
          <div id="enemyIntelligenceBar" class="bar bg-green-400 h-full w-0"></div>
          <span id="enemyIntelligenceText" class="absolute bar-text text-[11px] sm:text-xs">IQ 0</span>
        </div>
      </div>

      <div class="flex flex-wrap justify-center gap-2">
        <button id="attackBtn" class="bg-red-600 px-3 sm:px-4 py-2 rounded-xl font-bold text-sm sm:text-base flex-1 min-w-[80px]">Attack</button>
        <button id="defendBtn" class="bg-gray-600 px-3 sm:px-4 py-2 rounded-xl font-bold text-sm sm:text-base flex-1 min-w-[80px]">Defend</button>
        <button id="specialBtn" class="bg-purple-600 px-3 sm:px-4 py-2 rounded-xl font-bold text-sm sm:text-base flex-1 min-w-[80px]">Special (-40 MP)</button>
        <button id="healBtn" class="bg-green-600 px-3 sm:px-4 py-2 rounded-xl font-bold text-sm sm:text-base flex-1 min-w-[80px]">Heal (+20 HP)</button>
        <button id="resetBtn" class="bg-yellow-500 px-3 sm:px-4 py-2 rounded-xl font-bold text-sm sm:text-base flex-1 min-w-[80px]">Reset</button>
      </div>

      <div id="battleLog" class="bg-gray-900/70 text-gray-100 p-3 rounded-lg overflow-y-auto text-xs sm:text-sm shadow-inner" style="max-height:25vh;"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <button id="startBtn" class="mt-4 sm:mt-6 px-6 py-3 sm:px-8 sm:py-4 bg-emerald-600 hover:bg-emerald-700 rounded-2xl text-white font-bold text-base sm:text-lg shadow-lg">
    Start Game
  </button>

<script>
/* ========= Wallet & parent message handling ========= */

const gameArea=document.getElementById('gameArea');
const startBtn=document.getElementById('startBtn');
const attackBtn=document.getElementById('attackBtn');
const defendBtn=document.getElementById('defendBtn');
const specialBtn=document.getElementById('specialBtn');
const healBtn=document.getElementById('healBtn');
const resetBtn=document.getElementById('resetBtn');
const battleLog=document.getElementById('battleLog');
const playerHealthBar=document.getElementById('playerHealthBar');
const playerManaBar=document.getElementById('playerManaBar');
const playerHealthText=document.getElementById('playerHealthText');
const playerManaText=document.getElementById('playerManaText');
const enemyHealthBar=document.getElementById('enemyHealthBar');
const enemyManaBar=document.getElementById('enemyManaBar');
const enemyHealthText=document.getElementById('enemyHealthText');
const enemyManaText=document.getElementById('enemyManaText');
const enemyIntelligenceBar=document.getElementById('enemyIntelligenceBar');
const enemyIntelligenceText=document.getElementById('enemyIntelligenceText');
const toast=document.getElementById('toast');
const playerWins=document.getElementById('playerWins');
const enemyWins=document.getElementById('enemyWins');
const score=document.getElementById('score');
const aiIQ=document.getElementById('aiIQ');
const connectedAddrEl=document.getElementById('connectedAddr');

let connectedAddress=null;
const BACKEND_URL="https://rpg-backend-gocj.onrender.com/api/reward"; // Fixed backend URL
let parentWindowRef=null;
let parentOrigin=null;

const MAX_HP=200,MAX_MP=50,SPECIAL_COST=40,HEAL_COST=30,HEAL_HP=20;
let playerHP=MAX_HP,playerMP=MAX_MP,enemyHP=MAX_HP,enemyMP=MAX_MP;
let enemyIQ=0,enemyDefending=false,playerDefending=false;
let scores={player:0,enemy:0,score:0};
let aiInterval=null,aiActive=false;

const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const log=t=>{const p=document.createElement('p');p.innerText=t;battleLog.appendChild(p);battleLog.scrollTop=battleLog.scrollHeight;};
function showToast(msg){toast.innerText=msg;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),2500);}

// üîπ Receive wallet address from parent (only)
window.addEventListener('message',(ev)=>{
  const allowed=["https://zaddiii.github.io","http://localhost:5500","http://localhost:3000"];
  const okOrigin=(ev.origin===window.origin)||allowed.some(a=>ev.origin.startsWith(a));
  if(!okOrigin)return;
  const data=ev.data||{};
  if(ev.source){parentWindowRef=ev.source;parentOrigin=ev.origin||"*";}
  if(data.type==="CONNECT_WALLET" && data.address){
    connectedAddress=data.address;
    connectedAddrEl.textContent=connectedAddress;
    log("‚úÖ Wallet address received from parent.");
    try{
      parentWindowRef?.postMessage?.({type:"WALLET_RECEIVED",address:connectedAddress},parentOrigin||"*");
    }catch(e){}
  }
});

// üîπ Request wallet if opener didn‚Äôt send it yet
function requestAddressFromOpener(){
  try{
    if(window.opener && !window.opener.closed){
      window.opener.postMessage({type:"REQUEST_PARENT_ADDRESS"},"*");
    }
  }catch(e){}
}
setTimeout(requestAddressFromOpener,300);

// üîπ Reward logic (uses fixed backend URL)
async function sendReward(){
  if(!connectedAddress){
    log("‚ö†Ô∏è No wallet address connected, reward skipped.");
    showToast("No wallet address connected!");
    return;
  }
  const payload={to:connectedAddress,amount:50};
  showToast("Claiming reward...");
  try{
    const res=await fetch(BACKEND_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const json=await res.json().catch(()=>null);
    if(res.ok && json?.ok){
      showToast("‚úÖ Reward requested successfully!");
    } else {
      showToast("‚ùå Reward failed.");
    }
  }catch(e){
    showToast("‚ö†Ô∏è Network error.");
  }
}

/* ============ Game Logic ============ */
function updateBars(){playerHealthBar.style.width=(playerHP/MAX_HP*100)+'%';playerManaBar.style.width=(playerMP/MAX_MP*100)+'%';enemyHealthBar.style.width=(enemyHP/MAX_HP*100)+'%';enemyManaBar.style.width=(enemyMP/MAX_MP*100)+'%';playerHealthText.innerText=`${playerHP}/${MAX_HP}`;playerManaText.innerText=`${playerMP}/${MAX_MP}`;enemyHealthText.innerText=`${enemyHP}/${MAX_HP}`;enemyManaText.innerText=`${enemyMP}/${MAX_MP}`;enemyIntelligenceBar.style.width=enemyIQ+'%';enemyIntelligenceText.innerText=`IQ ${enemyIQ.toFixed(1)}`;}
function updateScoreboard(){playerWins.innerText=scores.player;enemyWins.innerText=scores.enemy;score.innerText=scores.score;aiIQ.innerText=enemyIQ.toFixed(1);}
function decideAction(){let actions=['Attack','Defend','Heal','Special'];if(enemyMP<HEAL_COST)actions=actions.filter(a=>a!=='Heal');if(enemyMP<SPECIAL_COST)actions=actions.filter(a=>a!=='Special');return actions[randInt(0,actions.length-1)];}
function getAISpeed(){return 300;}
function enemyAction(){if(!aiActive)return;if(playerHP<=0||enemyHP<=0)return;const action=decideAction();if(action==='Attack'){const dmg=randInt(18,35);const actual=playerDefending?Math.floor(dmg/2):dmg;playerHP=clamp(playerHP-actual,0,MAX_HP);log(`Enemy attacks ‚Üí ${actual} dmg.`);}else if(action==='Defend'){enemyDefending=true;log('Enemy defends.');}else if(action==='Special'&&enemyMP>=SPECIAL_COST){enemyMP-=SPECIAL_COST;const dmg=randInt(15,40);const actual=playerDefending?Math.floor(dmg/2):dmg;playerHP=clamp(playerHP-actual,0,MAX_HP);log(`Enemy uses Special ‚Üí ${actual} dmg.`);}else if(action==='Heal'&&enemyMP>=HEAL_COST){enemyMP-=HEAL_COST;enemyHP=clamp(enemyHP+HEAL_HP,0,MAX_HP);log('Enemy heals +20 HP.');}checkEnd();updateBars();}
function playerAction(act){if(!aiActive){aiActive=true;startAI();log("AI engages after your first move!");}playerDefending=false;if(act==='Attack'){const dmg=randInt(12,28);const actual=enemyDefending?Math.floor(dmg/2):dmg;enemyHP=clamp(enemyHP-actual,0,MAX_HP);log(`Player attacks ‚Üí ${actual} dmg.`);}else if(act==='Defend'){playerDefending=true;log('Player defends.');}else if(act==='Special'){if(playerMP<SPECIAL_COST){showToast('Not enough MP!');return;}playerMP-=SPECIAL_COST;const dmg=randInt(15,40);const actual=enemyDefending?Math.floor(dmg/2):dmg;enemyHP=clamp(enemyHP-actual,0,MAX_HP);log(`Player uses Special ‚Üí ${actual} dmg.`);}else if(act==='Heal'){if(playerMP<HEAL_COST){showToast('Not enough MP!');return;}playerMP-=HEAL_COST;playerHP=clamp(playerHP+HEAL_HP,0,MAX_HP);log('Player heals +20 HP.');}checkEnd();updateBars();}
function checkEnd(){if(playerHP<=0||enemyHP<=0){aiActive=false;clearInterval(aiInterval);if(playerHP<=0&&enemyHP<=0){showToast("Tie!");}else if(playerHP<=0){scores.enemy++;showToast("Enemy wins!");}else if(enemyHP<=0){scores.player++;scores.score++;showToast("Player wins!");sendReward();}updateScoreboard();}}
function startAI(){aiInterval=setInterval(()=>enemyAction(),getAISpeed());}
function resetGame(){clearInterval(aiInterval);aiActive=false;playerHP=MAX_HP;playerMP=MAX_MP;enemyHP=MAX_HP;enemyMP=MAX_MP;updateBars();updateScoreboard();battleLog.innerHTML='';showToast("Game reset!");}

startBtn.addEventListener('click',()=>{gameArea.classList.remove('hidden');startBtn.style.display='none';log("Game started!");});
attackBtn.addEventListener('click',()=>playerAction('Attack'));
defendBtn.addEventListener('click',()=>playerAction('Defend'));
specialBtn.addEventListener('click',()=>playerAction('Special'));
healBtn.addEventListener('click',()=>playerAction('Heal'));
resetBtn.addEventListener('click',()=>resetGame());
updateBars();updateScoreboard();
</script>
</body>
</html>